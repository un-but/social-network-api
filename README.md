# Auth Test Task - выполненное тестовое задание на создание системы аутентификации и авторизации

## Описание

Бэкенд-приложение реализует собственную систему аутентификации и авторизации, не ограничиваясь стандартными решениями фреймворков. Основная задача — спроектировать и реализовать схему контроля доступа, включая структуру базы данных для хранения правил доступа и разрешённых действий пользователей.

> [!WARNING]
> Основной целью этого приложения является написать максимально эффективный API, не вникая в излишнюю оптимизацию. Поэтому в проекте отсутствует пагинация, усложненная фильтрация и т.п., которые могут быть добавлены позже по необходимости. Помимо этого настройки окружения реализованы в docker-compose.yml, чтобы можно было сразу развернуть приложение без лишних настроек.
>
> Также отдельно отмечу, что в силу автодокументации FastAPI некоторые возможные оптимизации (например универсальная проверка про правилам в зависимостях) невозможна, и реализована через обычные функции.
>
> При тестировании не забывайте, что это API, и подразумевается, что он будет использоваться на фронтенде. С этим связано разделение эндпоинтов на создание пользователя и входом, а также истечение access токена за 5 минут.

## Установка и запуск

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/un-but/auth-test-task.git
   cd auth-test-task
   ```

2. Настройте пароли и другие переменные в docker-compose.yml.
   Рекомендуется заменить как минимум API_JWT_SECRET.

2. Запустите сервисы через Docker Compose (все миграции применяются автоматически):
   ```bash
   docker-compose up --build
   ```

   Это поднимет контейнеры для приложения, PostgreSQL и Redis.

3. Приложение будет доступно на http://localhost:8000.
   Удобное тестирование доступно через http://localhost:8000/docs с помощью Swagger UI.

4. Войдите в аккаунт админа с почтой admin@example.com и паролем admin_password. Рекомендуется заменить как минимум пароль.

5. Не забывайте обновлять токен каждые 5 минут (пояснения причин в начале этого файла), а также учитвайте, что создание/удаление пользователя не означает вход/выход из его аккаунта.

## Основные возможности

### 1. Работа с пользователями

- **Регистрация:** Имя, email, пароль (подразумевается подтверждение пароля на фронтенде).
- **Редактирование профиля:** Возможность изменить данные.
- **Мягкое удаление:** Пользователь может удалить аккаунт (is_active=False), выйти из системы и не сможет войти снова, но данные сохраняются в базе.
- **Вход/выход:** Аутентификация по email и паролю, идентификация пользователя в последующих запросах.

### 2. Система контроля доступа

- Своя схема хранения ограничений доступа.
- Таблицы для ролей, бизнес-элементов и правил доступа.
- API для просмотра и изменения правил.
- Обработка ошибок:
  - `401 Unauthorized` — пользователь не идентифицирован.
  - `403 Forbidden` — недостаточно прав для доступа.

## Технологии

- FastAPI + PostgreSQL
- bcrypt для паролей
- PyJWT для токенов
- Redis для refresh токенов (через куки)

## Структура базы данных

- **users:** Пользователи (id, is_active, role, name, created_at, email, password)
- **posts:** Посты (id, created_at, content, user_id)
- **comments:** Комментарии (id, created_at, content, user_id, post_id)
- **role_rules:** Правила доступа для ролей и объектов (role, object_type, action, owned, allowed, full_access)
